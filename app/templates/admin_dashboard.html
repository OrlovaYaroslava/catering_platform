{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥</h1>

    <!-- –§–ò–õ–¨–¢–† –ü–ï–†–ò–û–î–ê -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">–° –¥–∞—Ç—ã</label>
                    <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-outline-secondary w-100">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </form>
        </div>
    </div>

    <!-- –ö–õ–Æ–ß–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò (4 –∫–∞—Ä—Ç–æ—á–∫–∏) -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card bg-primary text-white h-100 kpi-card">
                <div class="card-body text-center">
                    <h5 class="card-title">üí∞ –í—ã—Ä—É—á–∫–∞</h5>
                    <h2 class="display-6">{{ total_revenue }} ‚ÇΩ</h2>
                    <small>–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card bg-success text-white h-100 kpi-card">
                <div class="card-body text-center">
                    <h5 class="card-title">üì¶ –ó–∞–∫–∞–∑—ã</h5>
                    <h2 class="display-6">{{ total_orders }}</h2>
                    <small>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card bg-info text-white h-100 kpi-card">
                <div class="card-body text-center">
                    <h5 class="card-title">üë• –ö–ª–∏–µ–Ω—Ç—ã</h5>
                    <h2 class="display-6">{{ total_clients }}</h2>
                    <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card bg-warning text-dark h-100 kpi-card">
                <div class="card-body text-center">
                    <h5 class="card-title">üìà –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</h5>
                    <h2 class="display-6">{{ avg_check }} ‚ÇΩ</h2>
                    <small>–ù–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑</small>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–†–ê–§–ò–ö–ò -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">üìä –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–û–ü –ë–õ–Æ–î –ò –ö–õ–ò–ï–ù–¢–û–í -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">üçΩ –¢–æ–ø-5 –±–ª—é–¥ –ø–æ –≤—ã—Ä—É—á–∫–µ</h5>
                </div>
                <div class="card-body">
                    {% if top_dishes %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–ë–ª—é–¥–æ</th>
                                    <th class="text-end">–ó–∞–∫–∞–∑–æ–≤</th>
                                    <th class="text-end">–í—ã—Ä—É—á–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dish in top_dishes %}
                                <tr>
                                    <td>{{ dish.name }}</td>
                                    <td class="text-end">{{ dish.quantity }}</td>
                                    <td class="text-end">{{ dish.revenue }} ‚ÇΩ</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">üèÜ –¢–æ–ø-5 –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                </div>
                <div class="card-body">
                    {% if top_clients %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                                    <th class="text-end">–ó–∞–∫–∞–∑–æ–≤</th>
                                    <th class="text-end">–°—É–º–º–∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in top_clients %}
                                <tr>
                                    <td>{{ client.email }}</td>
                                    <td class="text-end">{{ client.orders_count }}</td>
                                    <td class="text-end">{{ client.total_spent }} ‚ÇΩ</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –í–û–†–û–ù–ö–ê –ü–†–û–î–ê–ñ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üìä –í–æ—Ä–æ–Ω–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h5>
        </div>
        <div class="card-body">
            {% if funnel.created > 0 %}
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>–°–æ–∑–¥–∞–Ω–æ</span>
                    <span>{{ funnel.created }} (100%)</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-primary" style="width: 100%">{{ funnel.created }}</div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>–û–ø–ª–∞—á–µ–Ω–æ</span>
                    <span>{{ funnel.paid }} ({{ funnel.paid_percent }}%)</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-success" style="width: {{ funnel.paid_percent }}%">{{ funnel.paid }}</div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>–í —Ä–∞–±–æ—Ç–µ</span>
                    <span>{{ funnel.cooking }} ({{ funnel.cooking_percent }}%)</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-warning text-dark" style="width: {{ funnel.cooking_percent }}%">{{ funnel.cooking }}</div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>–ì–æ—Ç–æ–≤–æ</span>
                    <span>{{ funnel.ready }} ({{ funnel.ready_percent }}%)</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-info" style="width: {{ funnel.ready_percent }}%">{{ funnel.ready }}</div>
                </div>
            </div>
            <div>
                <div class="d-flex justify-content-between mb-1">
                    <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                    <span>{{ funnel.completed }} ({{ funnel.completed_percent }}%)</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-secondary" style="width: {{ funnel.completed_percent }}%">{{ funnel.completed }}</div>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Python –≤ JS -->
<script>
    const revenueLabels = {{ revenue_labels | tojson | default('[]') }};
    const revenueData = {{ revenue_data | tojson | default('[]') }};
    const statusData = {{ status_data | tojson | default('[0,0,0,0,0]') }};
</script>

<!-- –ù–∞—à admin.js -->
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
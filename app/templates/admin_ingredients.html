{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º</h1>
        <div>
            <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-outline-secondary">
                ‚Üê –ù–∞ –¥–∞—à–±–æ—Ä–¥
            </a>
        </div>
    </div>

    <!-- –ü–û–ö–ê–ó–ê–¢–ï–õ–ò -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å</h5>
                    <h2 class="display-6">{{ stock_fill }}%</h2>
                    <small>–û—Ç –Ω–æ—Ä–º–∞—Ç–∏–≤–∞</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">‚ö†Ô∏è –î–µ—Ñ–∏—Ü–∏—Ç</h5>
                    <h2 class="display-6">{{ deficit_count }}</h2>
                    <small>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">–ù–∏–∑–∫–∏–π –∑–∞–ø–∞—Å</h5>
                    <h2 class="display-6">{{ low_stock_count }}</h2>
                    <small>–¢—Ä–µ–±—É—é—Ç –∑–∞–∫—É–ø–∫–∏</small>
                </div>
            </div>
        </div>
    </div>

    <!-- üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –î–ï–§–ò–¶–ò–¢ -->
    {% set deficit_items = ingredients|selectattr('status', 'equalto', 'deficit')|list %}
    {% if deficit_items %}
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç ({{ deficit_items|length }})</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                            <th class="text-end">–û—Å—Ç–∞—Ç–æ–∫</th>
                            <th class="text-end">–ù–æ—Ä–º–∞</th>
                            <th>–î–µ—Ñ–∏—Ü–∏—Ç</th>
                            <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ing in deficit_items %}
                        <tr class="table-danger">
                            <td><strong>{{ ing.name }}</strong></td>
                            <td class="text-end text-danger"><strong>{{ ing.stock_quantity }} {{ ing.unit }}</strong></td>
                            <td class="text-end">{{ ing.min_quantity }} {{ ing.unit }}</td>
                            <td><span class="badge bg-danger">‚àí{{ (ing.min_quantity - ing.stock_quantity)|round(1) }} {{ ing.unit }}</span></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-danger" 
                                        onclick="updateIngredient({{ ing.id }}, '{{ ing.name }}', {{ ing.stock_quantity }}, '{{ ing.unit }}')">
                                    ‚úèÔ∏è –°—Ä–æ—á–Ω–æ!
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- üü° –ù–ò–ó–ö–ò–ô –ó–ê–ü–ê–° -->
    {% set low_items = ingredients|selectattr('status', 'equalto', 'low')|list %}
    {% if low_items %}
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üü° –ù–∏–∑–∫–∏–π –∑–∞–ø–∞—Å ({{ low_items|length }})</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                            <th class="text-end">–û—Å—Ç–∞—Ç–æ–∫</th>
                            <th class="text-end">–ù–æ—Ä–º–∞</th>
                            <th>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</th>
                            <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ing in low_items %}
                        <tr>
                            <td><strong>{{ ing.name }}</strong></td>
                            <td class="text-end text-warning">{{ ing.stock_quantity }} {{ ing.unit }}</td>
                            <td class="text-end">{{ ing.min_quantity }} {{ ing.unit }}</td>
                            <td><span class="badge bg-warning text-dark">‚àí{{ (ing.min_quantity - ing.stock_quantity)|round(1) }} {{ ing.unit }}</span></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning" 
                                        onclick="updateIngredient({{ ing.id }}, '{{ ing.name }}', {{ ing.stock_quantity }}, '{{ ing.unit }}')">
                                    ‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- üü¢ –ù–û–†–ú–ê (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    {% set normal_items = ingredients|selectattr('status', 'equalto', 'ok')|list %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <button class="btn btn-link text-white text-decoration-none p-0" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#normalStock" 
                    aria-expanded="false">
                üü¢ –ù–æ—Ä–º–∞ ({{ normal_items|length }}) ‚Äî –ù–∞–∂–º–∏ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å
            </button>
        </div>
        <div class="collapse" id="normalStock">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                <th class="text-end">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th class="text-end">–ù–æ—Ä–º–∞</th>
                                <th>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å</th>
                                <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ing in normal_items %}
                            <tr>
                                <td>{{ ing.name }}</td>
                                <td class="text-end">{{ ing.stock_quantity }} {{ ing.unit }}</td>
                                <td class="text-end">{{ ing.min_quantity }} {{ ing.unit }}</td>
                                <td>
                                    {% set fill_percent = (ing.stock_quantity / ing.min_quantity * 100)|round(0) %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" 
                                             style="width: {{ [fill_percent, 100]|min }}%">
                                            {{ fill_percent }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-success" 
                                            onclick="updateIngredient({{ ing.id }}, '{{ ing.name }}', {{ ing.stock_quantity }}, '{{ ing.unit }}')">
                                        ‚úèÔ∏è
                                    </button>
                                    <a href="{{ url_for('main.ingredient_history', ingredient_id=ing.id) }}" 
                                    class="btn btn-sm btn-outline-info" 
                                    title="–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">
                                        üìã
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% if ingredients|length == 0 %}
    <div class="alert alert-info">
        <p class="mb-0">üì≠ –ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ seed-—Å–∫—Ä–∏–ø—Ç.</p>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.admin_update_ingredient') }}">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ingredient_id" id="modal_ingredient_id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</label>
                        <input type="text" class="form-control" id="modal_ingredient_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                        <input type="text" class="form-control" id="modal_current_stock" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ <span class="text-danger">*</span></label>
                        <input type="number" step="0.01" name="new_stock" id="modal_new_stock" 
                               class="form-control" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                        <textarea name="comment" id="modal_comment" class="form-control" rows="2" 
                                  placeholder="–ó–∞–∫—É–ø–∫–∞, —Å–ø–∏—Å–∞–Ω–∏–µ, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateIngredient(id, name, currentStock, unit) {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –ø–æ–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('modal_ingredient_id').value = id;
    document.getElementById('modal_ingredient_name').value = name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    document.getElementById('modal_current_stock').value = currentStock + ' ' + (unit || '');
    document.getElementById('modal_new_stock').value = '';
    document.getElementById('modal_comment').value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('updateModal'));
    modal.show();
}
</script>
{% endblock %}